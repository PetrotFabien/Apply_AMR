
{% extends "base.html" %}
{% block title %}Article #{{ it['id'] }} – Raspi Stock{% endblock %}
{% block content %}
<h2>Article #{{ it['id'] }} — {{ it['sku'] }}</h2>
<p class="muted">{{ it['description'] or '' }}</p>

<div class="grid2">
  <div class="card">
    <h3>Etat actuel</h3>
    <p><strong>Statut :</strong> {{ it['status'] }}</p>
    <p><strong>Emplacement :</strong> {{ loc['code'] if loc else '—' }}</p>
    {% if it['photo_path'] %}
      <p><img src="{{ url_for('uploads', filename=it['photo_path']) }}" alt="Photo" style="max-width:100%;height:auto"></p>
    {% endif %}
  </div>

  <div class="card">
    <h3>Mouvements rapides</h3>
    <form method="post" action="{{ url_for('to_poste', item_id=it['id'], poste_code='POSTE-PHOTO') }}" class="inline">
      <button type="submit">→ Poste Photo</button>
    </form>
    <form method="post" action="{{ url_for('to_poste', item_id=it['id'], poste_code='POSTE-INSPECTION') }}" class="inline">
      <button type="submit">→ Inspection</button>
    </form>
    <form method="post" action="{{ url_for('to_poste', item_id=it['id'], poste_code='POSTE-EMBALLAGE') }}" class="inline">
      <button type="submit">→ Emballage</button>
    </form>

    <h4>Mettre en stock</h4>
    <form method="post" action="{{ url_for('move', item_id=it['id']) }}">
      <select name="to_location_id" required>
        <optgroup label="Sol (libres)">
          {% for s in sol_free %}<option value="{{ s['id'] }}">{{ s['code'] }}</option>{% endfor %}
        </optgroup>
        <optgroup label="Etagères (libres)">
          {% for s in etg_free %}<option value="{{ s['id'] }}">{{ s['code'] }}</option>{% endfor %}
        </optgroup>
      </select>
      <button type="submit">Déplacer</button>
    </form>

    <h4>Uploader une photo</h4>
    <form method="post" enctype="multipart/form-data" action="{{ url_for('upload_photo', item_id=it['id']) }}">
      <input type="file" name="photo" accept="image/*">
      <button type="submit">Envoyer</button>
    </form>
  </div>
</div>

<div class="card">
  <h3>Références</h3>
  <p><strong>Avis :</strong> {{ it['avis_no'] or '—' }}</p>
  <p><strong>Commande :</strong> {{ it['order_no'] or '—' }}</p>
  <p><strong>BL :</strong> {{ it['bl_no'] or '—' }}</p>

  <h4>Modifier</h4>
  <form method="post" action="{{ url_for('update_refs', item_id=it['id']) }}">
    <input name="avis_no" placeholder="Numéro d'avis" value="{{ it['avis_no'] or '' }}">
    <input name="order_no" placeholder="Numéro de commande" value="{{ it['order_no'] or '' }}">
    <input name="bl_no" placeholder="Numéro de BL" value="{{ it['bl_no'] or '' }}">
    <button type="submit">Enregistrer</button>
  </form>
</div>

<h3>Historique</h3>
<table class="table">
  <thead><tr><th>Date</th><th>Action</th><th>De</th><th>Vers</th><th>Utilisateur</th></tr></thead>
  <tbody>
    {% for m in moves %}
      <tr>
        <td>{{ m['created_at'] }}</td>
        <td>{{ m['action'] }}</td>
        <td>{{ m['from_code'] or '—' }}</td>
        <td>{{ m['to_code'] or '—' }}</td>
        <td>{{ m['user'] or '—' }}</td>
      </tr>
    {% else %}
      <tr><td colspan="5" class="muted">Aucun mouvement.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
